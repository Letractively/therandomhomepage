<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="TheRandomHomepage-Java" default="backupWebsite" basedir=".">

    <property file="${user.home}/user.properties"/>
    <property name="widgets.source.dir" value="../widgets/Lightbox Image/java"/>
    <path id="lib.path">
        <fileset includes="../lib/*.jar"/>
    </path>

    <property name="build.dir" value="./build"/>
    <property name="backup.dir" value="${build.dir}/backups"/>
    <property name="widgets.output.dir" value="./build/widgets"/>

    <defaultexcludes echo="true" add="**/out/**"/>
    <defaultexcludes echo="true" add="**/tomcat/**"/>
    <defaultexcludes echo="true" add="**/.gwt-cache/**"/>
    <defaultexcludes add="**/.svn"/>
    <defaultexcludes add="**/.svn/**"/>
    <defaultexcludes add="**/_svn"/>
    <defaultexcludes add="**/_svn/**"/>

    <tstamp>
        <format property="build.time" pattern="MMMM-dd-yyyy-HH-mm"/>
    </tstamp>

    <target name="init">
        <mkdir dir="${build.dir}"/>
        <mkdir dir="${backup.dir}"/>
        <mkdir dir="${widgets.output.dir}"/>
    </target>

    <target name="clean">
        <delete dir="${backup.dir}"/>
        <delete dir="${build.dir}"/>
    </target>

    <target name="backupWebsite" depends="clean,init">
        <echo>Backing up ${ftp_host}...</echo>
        <ftp action="get"
             server="${ftp_host}"
             userid="${user_id}"
             password="${password}">
            <fileset dir="${backup.dir}">
                <include name="**/*"/>
                <exclude name="**/cache/**"/>
                <exclude name="**/_vti_cnf/**"/>
                <exclude name="**/stats/**"/>
            </fileset>
        </ftp>
        <jar destfile="${build.dir}/${ftp_host}-${build.time}.jar"
             basedir="${backup.dir}"
             includes="**"
                />
        <mail
                mailhost="${backup_mail_host}"
                mailport="${backup_mail_port}"
                from="${backup_mail_user}"
                tolist="${backup_mail_user}"
                user="${backup_mail_user}"
                password="${backup_mail_password}"
                ssl="on"
                encoding="mime"
                subject="Backup for ${ftp_host} since ${build.time}"
                message="Backup for ${ftp_host} since ${build.time}"
                files="${build.dir}/${build.time}.jar"/>
        <delete file="${build.dir}/${build.time}.jar"/>
    </target>

    <target name="backupUserProperties" depends="clean,init">
        <copyfile src="${user.home}/user.properties" dest="user.properties"/>
        <echo>Backing up user.properties...</echo>
        <mail
                mailhost="${backup_mail_host}"
                mailport="${backup_mail_port}"
                from="${backup_mail_user}"
                tolist="${backup_mail_user}"
                user="${backup_mail_user}"
                password="${backup_mail_password}"
                ssl="on"
                encoding="mime"
                subject="Backup of user properties"
                message="Backup of user properties"
                files="user.properties"/>
    </target>

    <target name="buildWidgetsLibrary" description="FTP">
        <echo>Building widget library from source path ${widgets.source.dir}</echo>
        <javac srcdir="${widgets.source.dir}" target="${widgets.output.dir}" classpathref="lib.path">
            <includesfile name="therandomhomepage/widgets/client/**"/>
            <includesfile name="therandomhomepage/widgets/public/**"/>
        </javac>
    </target>


</project>
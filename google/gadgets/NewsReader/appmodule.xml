<?xml version="1.0" encoding="UTF-8" ?>
<Module>
    <ModulePrefs title="Google News Reader"
                 title_url="http://www.BoxySystems.com" description="A simple, sophisticated newsreader app with core focus on usability."
                 author="Siddique Hameed" author_email="siddii+randomhomepage@gmail.com" height="350" scrolling="true"
                 thumbnail="http://www.therandomhomepage.com/google/gadgets/DZonePreview/dzonethumbnail.png"
                 screenshot="http://www.therandomhomepage.com/google/gadgets/DZonePreview/dzonescreenshot.png"
                 author_affiliation="http://www.BoxySystems.com"
                 author_location = "St. Louis, MO"
                 author_photo = "http://www.therandomhomepage.com/images/author.jpg"
                 author_aboutme = "I  am an aspiring entrepreneur who loves crafting software both for living  and hobbies. Still searching for the perfect click of my life..."
                 author_link = "http://blogs.boxysystems.com"
                 author_quote = "World Wide Web is a sea of HTML, you never know what you gonna catch!"
            >
	<!--

		Last Updated : 2/08/2012
		Change Notes: First revision
	-->
	<Require feature="tabs"/>
    </ModulePrefs>
	<UserPref name="selectedTab" datatype="hidden" />
    <Content type="html">
<![CDATA[
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<link href="http://therandomhomepage.com/google/gadgets/DZonePreview/loading.css" rel="stylesheet"/>
<style type="text/css">
		img {
			border-style: none;
			cursor: pointer;
		}
      
    hr {
      width: 95%;
    }  
  
		td.tdSummary {
			font-size:80%;
		}

		div.title {
			font-weight: bold;
			font-size:90%;
		}

		a {
			color: #000000;
			text-decoration: none;
		}
      
    a:visited {
      color: gray;
    }  
    
    a:active {
      color: gray;
    }  

    a.topic {
      font-weight: bold;
      padding: 5px;
    }  
    
		a:hover {
			text-decoration: underline;
		}
      
    legend {
      font-weight: bold;
    }  

		div.closeTab {
			font-size:90%;
			margin-bottom: 5px;
			width: 100%;
			text-align: right;
		}

		div.feedItem {
			font-size:90%;
			margin-bottom: 5px;
		}

		ul {
			font-size:90%;
		}

		li {
			font-size:90%;
		}

		p {
			font-size:80%;
			font-weight: bold;
		}

		closeTab {
			width: 100%;
			text-align: right;
		}
      
</style>

 <script type="text/javascript">
  var tabs = new _IG_Tabs(__MODULE_ID__);
   
  var topics = {"b": "Business", "tc": "Technology", "m": "Health", "s": "Sports", "e": "Entertainment","snc": "Science","w": "World","n": "Nation","po": "Most Popular","ir": "Spotlight"};  
  var countryCodes = {"es_ar" : "Argentina", "au" : "Australia", "nl_be" : "België", "fr_be" : "Belgique", "en_bw" : "Botswana", "pt-BR_br" : "Brasil", "ca" : "Canada English", "fr_ca" : "Canada Français", "cs_cz" : "Ceská republika", "es_cl" : "Chile", "es_co" : "Colombia", "es_cu" : "Cuba", "de" : "Deutschland", "es" : "España", "es_us" : "Estados Unidos", "en_et" : "Ethiopia", "fr" : "France", "en_gh" : "Ghana", "in" : "India", "en_ie" : "Ireland", "en_il" : "Israel English", "it" : "Italia", "en_ke" : "Kenya", "hu_hu" : "Magyarország", "en_my" : "Malaysia", "es_mx" : "México", "en_na" : "Namibia", "nl_nl" : "Nederland", "nz" : "New Zealand", "en_ng" : "Nigeria", "no_no" : "Norge", "de_at" : "Österreich", "en_pk" : "Pakistan", "es_pe" : "Perú", "en_ph" : "Philippines", "pl_pl" : "Polska", "pt-PT_pt" : "Portugal", "de_ch" : "Schweiz", "fr_sn" : "Sénégal", "en_sg" : "Singapore", "en_za" : "South Africa", "fr_ch" : "Suisse", "sv_se" : "Sverige", "en_tz" : "Tanzania", "tr_tr" : "Türkiye", "uk" : "U.K.", "us" : "U.S.", "en_ug" : "Uganda", "es_ve" : "Venezuela", "vi_vn" : "Vit NamVietnam", "en_zw" : "Zimbabwe", "el_gr" : "daGreece", "ru_ru" : "Russia", "ru_ua" : "Ukraine", "uk_ua" : "Ukraine", "iw_il" : "Israel", "ar_ae" : "UAE", "ar_sa" : "KSA", "ar_me" : "Arabic", "ar_lb" : "Lebanon", "ar_eg" : "Egypt", "hi_in" : "India", "ta_in" : "India", "te_in" : "India", "ml_in" : "India", "kr" : "Korea", "cn" : "China", "tw" : "Taiwan", "jp" : "Japan", "hk" : "Hong Kong"};
  
	var  errorHTML = "<p align='center'>Unable to read content from Google News server! <br/>Please try again  later.</p>";
   
  var LOADING_MSG = '<div class="loading"><h3>Loading...</h3></div><div class="spinner" id="div1"><div class="bar1"></div><div class="bar2"></div><div class="bar3"></div><div class="bar4"></div><div class="bar5"></div><div class="bar6"></div><div class="bar7"></div><div class="bar8"></div></div>'; 
   
  var CACHE_INTERVAL = 1000 * 60 * 15; //15 min 
   
  var CacheTime = function(url,time) {
    this.url = url;
    this.time = time;
  }
  
  localStorage["cacheTimes"] = "";
   
  function getCacheTime(url) {
    if (localStorage["cacheTimes"] != null && localStorage["cacheTimes"] != "") {
      var cacheTimes = JSON.parse(localStorage["cacheTimes"]);
      for(var i=0; i < cacheTimes.length; i++) {
        if (cacheTimes[i].url === url) {
          return url;
        }
      }
    }
    return null; 
  } 
 
  function setCacheTime(url) {
    var cacheTimes = new Array();
    if (localStorage["cacheTimes"] != null && localStorage["cacheTimes"] != "") {
      cacheTimes = JSON.parse(localStorage["cacheTimes"]);
    }
    var date = new Date();
    var timeSet = false;
    for(var i=0; i < cacheTimes.length; i++) {
      if (cacheTimes[i].url === url) {
        cacheTimes[i].time = date.getTime();
        timeSet = true;
        break;         
      }
    }    
    if (!timeSet) {
      cacheTimes.push(new CacheTime(url,date.getTime()));      
    }    
    localStorage["cacheTimes"] = JSON.stringify(cacheTimes);
  }
  
  function isCacheExpired(url) {    
    var cacheTime = getCacheTime(url);
    var date = new Date();
    return cacheTime == null || ((date.getTime() - cacheTime) > CACHE_INTERVAL);
  }
 
  function getPreference(prefName,defaultValue) {
    console.log(" getPreference - prefName = "+prefName+" defaultValue = "+defaultValue+" localStorage = "+localStorage+" "+typeof localStorage[prefName]);
    if ((typeof localStorage != "undefined") && (localStorage[prefName] != null)) {
        console.log("returning - "+localStorage[prefName]);
        return localStorage[prefName];
    }
    
    if (typeof defaultValue != "undefined") {
      console.log("returning defaultValue - "+defaultValue);
      return defaultValue;
    }
    return "";
  } 
  
  function setPreference(prefName, prefValue) {
    if (typeof localStorage != "undefined") {
      localStorage[prefName] = prefValue;
    }
  }
  
  

	function loadModule__MODULE_ID__(){

		tabs.addDynamicTab("Top Stories", loadTabsCallbackGenerator("http://news.google.com/news?ned=us&topic=h&output=rss"));

		var savedTabs = getPreference("savedTabs").split("|");
      
     for (var i=0; i < savedTabs.length; i++)
     {       
        for(var key in topics) {
          if (key == savedTabs[i]) {
           var feedURL = buildFeedURL(key);
           tabs.addDynamicTab(topics[key], loadTabsCallbackGenerator(feedURL));                        
          }
        }     
     }

		tabs.addDynamicTab("Settings", settingsTabCallback());
	}

	function buildFeedURL(topicName){
    var selEditionValue = selEdition.value;
    console.log("selEditionValue = "+selEditionValue);
		var feedURL = "http://news.google.com/news?ned="+selEditionValue+"&topic="+topicName+"&output=rss"; 
		return feedURL;
	}


	function loadTabsCallbackGenerator(feedUrl) {
		return function(tabId) {
			loadTab(tabId, feedUrl);
		}
	}

	function settingsTabCallback() {
		return function(tabId) {
       if (_gel("settings") != null) {                  
         var container = _gel(tabId);
         container.innerHTML = _gel("settings").innerHTML;
         //$(container).replaceWith($("#settings"));
         $("#settings").remove();        
       }
		}
	}

	function tagCloudCallback(tabId) {

	}

	function createTabForTopic(topicName){
		var actualTabs = tabs.getTabs();
		var tabExist = false;
		for(var i=0; i < actualTabs.length; i++) {
			if (actualTabs[i].getName() == topics[topicName])
			{
				tabs.setSelectedTab(i);
				tabExist = true;
				break;
			}
		}

		if (!tabExist)
		{
			var feedURL = buildFeedURL(topicName);
			tabs.addDynamicTab(topics[topicName], loadTabsCallbackGenerator(feedURL));
			tabs.moveTab(i-1,i);
			tabs.setSelectedTab(i-1);
         
      var savedTabs = getPreference("savedTabs").split("|");   
      savedTabs.push(topicName); 
      setPreference("savedTabs",savedTabs.join("|"));
		}
	}

   function loadTab(tabId,feedUrl) {
	   var container = _gel(tabId);
	   container.innerHTML = "<p>Loading...</p>";
      
     if (localStorage[feedUrl] != null && !isCacheExpired(feedUrl)) {
       console.log("Loading tab from localStorage");
       container.innerHTML = localStorage[feedUrl];
       return;
     } 

     console.log("Loading tab from server");
	   _IG_FetchXmlContent(
		feedUrl,
		function(feed) {
			showFeeds(container, tabId, feed,  feedUrl)
		});

	}

	function removeSelectedTab(){

		if (tabs.getSelectedTab() != null)
		{
			var tabName = tabs.getSelectedTab().getName();
			var response = confirm("Are you sure you want to remove '"+tabName+"' tab ?");

			if (response)
			{
        var tabIdx = tabs.getSelectedTab().getIndex();
        var removedTabName = tabs.getSelectedTab().getName();
				tabs.removeTab(tabIdx);
				tabs.setSelectedTab(tabIdx);
            
        console.log("savedTabs = "+getPreference("savedTabs"));
        
				var savedTabs = getPreference("savedTabs").split("|");

            var newTabs = new Array();
            for (var i=0; i < savedTabs.length; i++)
            {
                for(var key in topics) {                   
                   if (savedTabs[i] == key && topics[key] != removedTabName) {
                      newTabs.push(savedTabs[i]);
                      break;
                    }
                }
            }
            
            var newTabsStr = newTabs.length > 0 ? newTabs.join("|") : "";
            console.log("newTabsStr = "+newTabsStr);
            setPreference("savedTabs",newTabsStr);
			}
		}
	}

	function showFeeds(container, tabId, response, feedUrl){
		 if (response == null || typeof(response) != "object" ||
                      response.firstChild == null) {
              container.innerHTML = errorHTML;
              return;
         }

		if (response.firstChild) {

			var linksHTML = '';

			var savedTabs = getPreference("savedTabs").split("|");
      
     for (var i=0; i < savedTabs.length; i++)
     {       
        for(var key in topics) {
           if (savedTabs[i] == key && topics[key] == tabs.getSelectedTab().getName()) {
            linksHTML += '<div class="closeTab"><a title="Remove Tab" href="javascript:alert('Removing tab');"><img src="http://therandomhomepage.com/google/gadgets/DZonePreview/delete.png"/></a></div>';               
           }
        }     
     }

			var itemList = response.getElementsByTagName("item");

             for (var i = 0; i < itemList.length; i++) {

			 	var title = getChildNodeValueByNodeName(itemList.item(i),"title");
				var link = getChildNodeValueByNodeName(itemList.item(i),"link");
				var description = getChildNodeValueByNodeName(itemList.item(i),"description");

				//linksHTML  += '<div><table><tr><td><div  class="title"><a class="titleLink" target="_new"  href="'+link+'">'+title+'</a></div></td></tr>';
        linksHTML  +=  '<div><table>';
    
				var divSummary = document.createElement("div");
				divSummary.innerHTML = description;

				linksHTML += '<tr><td valign="top" class="tdSummary">'+divSummary.innerHTML+'</td></tr>'
				linksHTML += '</table></div>';
            
        if (i != itemList.length-1) {
          linksHTML += '<hr/>';
        }            

             }
           $('#placeholder').html(linksHTML);   
    
           $('#placeholder').find('a').attr("target","_new");
           
           //$('#placeholder').find("br").remove();
           
           $('#placeholder').find('font br:first-child').remove();
           $('#placeholder').find('font div:first-child').remove();
           
           var tds = $('#placeholder').find('td .j');
           
           for(var i=0; i < tds.length; i++) {
              $(tds[i]).find('font,br').each(function(idx, item) {
                  if (idx > 6) {
                    $(item).remove();                   
                  }                  
              });                                
           }
           

           container.innerHTML = $('#placeholder')[0].innerHTML;              
           localStorage[feedUrl] = container.innerHTML; 
           setCacheTime(feedUrl);
           $('#placeholder').empty();             
        }
	}

	function getChildNodeValueByNodeName(node,nodeNameStr){
		var nodeList = node.childNodes;
		 for (var j = 0; j < nodeList.length ; j++) {
			var node = nodeList.item(j);
			if (node.nodeName == nodeNameStr && node.firstChild)
			{
				return node.firstChild.nodeValue;
			}
		 }
	}

 _IG_RegisterOnloadHandler(loadModule__MODULE_ID__);
 </script>
 
 <div id="placeholder" style="display:none;"></div>
 
 <div id="settings" style="display:none;">
   <br/>  
   <center>
     <b>News Edition:</b>
             <select id="selEdition">
               <option value="au">Australia</option>
               <option value="ca">Canada</option>
               <option value="in">India</option>
               <option value="ie">Ireland</option>
               <option value="nz">New Zealand</option> 
               <option value="en_za">South Africa</option> 
               <option value="uk">UK</option> 
               <option selected="selected" value="us">US</option>               
             </select>    
   </center>  
   <br/>

   <fieldset>
   <legend>Topics:</legend>
   <center>
  <a class="topic" href="javascript:createTabForTopic('w');">
       World    
  </a>        
  <a class="topic" href="javascript:createTabForTopic('n');">
       Nation    
  </a>          
  <a class="topic" href="javascript:createTabForTopic('b');">
    Business
  </a>
  <a class="topic" href="javascript:createTabForTopic('tc');">
    Technology
  </a>  
  <a class="topic" href="javascript:createTabForTopic('m');">
     Health
   </a>    
  <a class="topic" href="javascript:createTabForTopic('s');">
     Sports
   </a>    
  <a class="topic" href="javascript:createTabForTopic('e');">
      Entertainment    
  </a>       
  <a class="topic" href="javascript:createTabForTopic('snc');">
       Science    
  </a>     
  <a class="topic" href="javascript:createTabForTopic('ir');">
      Spotlight
   </a>       
  <a class="topic" href="javascript:createTabForTopic('po');">
       Most Popular
    </a>          
  </center>  
  </div>

 ]]>
    </Content>
</Module>